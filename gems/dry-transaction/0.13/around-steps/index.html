<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta content="phone" media="(max-width: 480px)" name="breakpoint" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><meta content="website" property="og:type" /><meta content="Business transaction DSL for Ruby" name="description" /><meta content="dry-rb - dry-transaction v0.13 - Around steps" property="og:title" /><meta content="Business transaction DSL for Ruby" property="og:description" /><meta content="/images/favicon-651cfa16.png" property="og:image" /><meta content="summary" name="twitter:card" /><meta content="dry-rb - dry-transaction v0.13 - Around steps" name="twitter:title" /><meta content="Business transaction DSL for Ruby" name="twitter:description" /><meta content="/images/favicon-651cfa16.png" property="og:image" /><link href="/feed.xml" rel="alternate" title="dry-rb news" type="application/atom+xml" /><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:400,400i,600,600i" rel="stylesheet" /><link href="/images/favicon-651cfa16.png" rel="icon" /><link href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" rel="stylesheet" /><!--[if IE]><link href="/images/favicon.ico" rel="shortcut icon" /><![endif]--><title>dry-rb - dry-transaction v0.13 - Around steps</title><link href="/assets/stylesheets/site-9fe218b6.css" rel="stylesheet" /><script src="/assets/javascripts/site-948a8a19.js"></script></head><body><header><div class="content-wrap"><nav class="main-nav"><ul class="main-nav__list"><li class="main-nav__logo"><a href="/">dry-rb</a></li><li class="main-nav__with-dropdown main-nav__item--selected"><a href="/gems">Gems <span class="hide-mobile">/ Docs </span></a><div class="main-nav__dropdown main-nav__dropdown--gems"><ul><li></li><a href="/gems/dry-auto_inject/1.0">dry-auto_inject</a><li></li><a href="/gems/dry-cli/1.1">dry-cli</a><li></li><a href="/gems/dry-configurable/1.0">dry-configurable</a><li></li><a href="/gems/dry-container/0.11">dry-container</a><li></li><a href="/gems/dry-core/1.0">dry-core</a><li></li><a href="/gems/dry-effects/0.4">dry-effects</a><li></li><a href="/gems/dry-equalizer/0.2">dry-equalizer</a><li></li><a href="/gems/dry-events/1.0">dry-events</a><li></li><a href="/gems/dry-files/1.0">dry-files</a><li></li><a href="/gems/dry-inflector/1.0">dry-inflector</a><li></li><a href="/gems/dry-initializer/3.1">dry-initializer</a><li></li><a href="/gems/dry-logger/1.0">dry-logger</a><li></li><a href="/gems/dry-logic/1.5">dry-logic</a></ul><ul><li></li><a href="/gems/dry-matcher/1.0">dry-matcher</a><li></li><a href="/gems/dry-monads/1.6">dry-monads</a><li></li><a href="/gems/dry-monitor/1.0">dry-monitor</a><li></li><a href="/gems/dry-operation/1.0">dry-operation</a><li></li><a href="/gems/dry-rails/0.7">dry-rails</a><li></li><a href="/gems/dry-schema/1.13">dry-schema</a><li></li><a href="/gems/dry-struct/1.6">dry-struct</a><li></li><a href="/gems/dry-system/1.0">dry-system</a><li></li><a href="/gems/dry-transaction/0.15">dry-transaction</a><li></li><a href="/gems/dry-transformer/1.0">dry-transformer</a><li></li><a href="/gems/dry-types/1.7">dry-types</a><li></li><a href="/gems/dry-validation/1.10">dry-validation</a><li></li><a href="/gems/dry-view/0.7">dry-view</a></ul></div></li><li><a href="/status">Status</a></li><li><a href="/news">News</a></li><li><a href="/community">Community</a></li><br class="mobile-only" /><li class="main-nav__search"><form class="searchbox"><input class="form-control" id="search-input" type="text" /></form><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js" type="text/javascript"></script><script>docsearch({
  apiKey: '77902a61218a8fbaa06a6125cb6589a7',
  indexName: 'dry-rb',
  inputSelector: '#search-input',
  debug: false // Set debug to true if you want to inspect the dropdown
});</script></li><li class="main-nav__code"><a href="https://github.com/dry-rb">Github</a></li></ul></nav></div></header><main><div class="intro-page"><div class="content-wrap"><div class="intro-page__inner"><h1 class="intro-page__header">dry-transaction <span class="hide">0.13</span></h1><p class="intro-page__link"><a href="https://github.com/dry-rb/dry-transaction">View dry-transaction on GitHub</a></p></div></div></div><div class="row"><div class="content-wrap"><aside class="sidebar"><h3 class="sidebar__version">Version: <select id="sidebar__version-switcher"><option value="/gems/dry-transaction/0.15">0.15</option><option value="/gems/dry-transaction/main">main</option><option value="/gems/dry-transaction/0.14">0.14</option><option selected="selected" value="/gems/dry-transaction/0.13">0.13</option><option value="/gems/dry-transaction/0.1">0.1</option></select></h3><ul><li><a href="/gems/dry-transaction/0.13" class="">Introduction</a><li><a href="/gems/dry-transaction/0.13/basic-usage" class="">Basic usage</a></li><li><a href="/gems/dry-transaction/0.13/wrapping-operations" class="">Wrapping operations</a></li><li><a href="/gems/dry-transaction/0.13/injecting-operations" class="">Injecting operations</a></li><li><a href="/gems/dry-transaction/0.13/step-notifications" class="">Step notifications</a></li><li><a href="/gems/dry-transaction/0.13/around-steps" class="active">Around steps</a></li><li><a href="/gems/dry-transaction/0.13/step-adapters" class="">Step adapters</a></li><li><a href="/gems/dry-transaction/0.13/custom-step-adapters" class="">Custom step adapters</a></li></li></ul></aside><article class="gem-article"><h2>Around steps</h2><p>Regular <code>step</code> operations take an input, act on it, and return an output to pass to the next step. They operate in sequence, with control being passed from one operation to the next.</p>

<p>Sometimes, a step operation needs to <em>wrap</em> all of the subsequent steps. A common case for this is handling database transactions. An operation providing a database transaction across steps needs to wrap around all the subsequent operations so it can roll back the transaction in case one of the operations failures.</p>

<p>Use an <code>around</code> step to give an operation this behavior. The operation will receive <code>#call(input, &amp;block)</code>, where <code>&amp;block</code> is the collection of steps it is wrapping. It should call the block to run those steps and handle as appropriate.</p>

<p>An operation to wrap steps in a database transaction would work like this (replace <code>MyDB</code> with whatever your database system requires):</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">MyContainer</span>
  <span class="kp">extend</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Container</span>

  <span class="n">register</span> <span class="s2">"transaction"</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
    <span class="n">result</span> <span class="o">=</span> <span class="kp">nil</span>

    <span class="k">begin</span>
      <span class="no">MyDB</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="p">(</span><span class="no">Success</span><span class="p">(</span><span class="n">input</span><span class="p">))</span>
        <span class="k">raise</span> <span class="no">MyDB</span><span class="o">::</span><span class="no">Rollback</span> <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">failure?</span>
        <span class="n">result</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="no">MyDB</span><span class="o">::</span><span class="no">Rollback</span>
      <span class="n">result</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>And can be integrated into a business transaction like this:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">MyOperation</span>
  <span class="kp">include</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Transaction</span><span class="p">(</span><span class="ss">container: </span><span class="no">MyContainer</span><span class="p">)</span>

  <span class="n">around</span> <span class="ss">:transaction</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"transaction"</span>

  <span class="c1"># Multiple subsequent steps writing to the database</span>
  <span class="n">step</span> <span class="ss">:create_user</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"users.create"</span>
  <span class="n">step</span> <span class="ss">:create_account</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"accounts.create"</span>
<span class="k">end</span>
</code></pre></div><p><a class="edit_page_link" href="https://github.com/dry-rb/dry-transaction/edit/release-0.13/docsite/source/around-steps.html.md"><span class="ss-icon ss-social octocat">octocat</span><span>Edit on GitHub</span></a></p></article></div></div></main><footer><div class="content-wrap"><nav class="footer__links"><ul><li><a href="/gems"><span>Gems</span></a></li><li><a href="/community"><span>Community</span></a></li><li><a href="https://github.com/dry-rb"><span>Code</span></a></li><li><a href="https://discourse.dry-rb.org"><span>Discussion</span></a></li><li><a href="https://dry-rb.zulipchat.com"><span>Chat</span></a></li><li><a href="https://twitter.com/dry_rb"><span>Twitter</span></a></li></ul></nav><div class="footer__credits"><p>Website made with love by <a href="https://www.icelab.com.au/">Icelab</a>.</p></div><div class="footer__credits"><p>Found a typo? Want to add something? <br />Send us an issue or a pull-request at <a href="https://github.com/dry-rb/dry-rb.org/">GitHub</a>.</p></div></div></footer></body></html>