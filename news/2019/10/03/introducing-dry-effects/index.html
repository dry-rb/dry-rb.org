<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta content="phone" media="(max-width: 480px)" name="breakpoint" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/feed.xml" rel="alternate" title="dry-rb news" type="application/atom+xml" /><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:400,400i,600,600i" rel="stylesheet" /><link href="/images/favicon-651cfa16.png" rel="icon" /><link href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" rel="stylesheet" /><!--[if IE]><link href="/images/favicon.ico" rel="shortcut icon" /><![endif]--><title>dry-rb - Introducing dry-effects</title><link href="/assets/stylesheets/site-9fe218b6.css" rel="stylesheet" /><script src="/assets/javascripts/site-948a8a19.js"></script></head><body><header><div class="content-wrap"><nav class="main-nav"><ul class="main-nav__list"><li class="main-nav__logo"><a href="/">dry-rb</a></li><li class="main-nav__with-dropdown"><a href="/gems">Gems <span class="hide-mobile">/ Docs </span></a><div class="main-nav__dropdown main-nav__dropdown--gems"><ul><li></li><a href="/gems/dry-auto_inject/0.6">dry-auto_inject</a><li></li><a href="/gems/dry-cli/0.6">dry-cli</a><li></li><a href="/gems/dry-configurable/0.16">dry-configurable</a><li></li><a href="/gems/dry-container/0.7">dry-container</a><li></li><a href="/gems/dry-core/0.4">dry-core</a><li></li><a href="/gems/dry-effects/0.1">dry-effects</a><li></li><a href="/gems/dry-equalizer/0.2">dry-equalizer</a><li></li><a href="/gems/dry-events/0.2">dry-events</a><li></li><a href="/gems/dry-files/0.1">dry-files</a><li></li><a href="/gems/dry-inflector/0.1">dry-inflector</a><li></li><a href="/gems/dry-initializer/3.0">dry-initializer</a><li></li><a href="/gems/dry-logger/main">dry-logger</a></ul><ul><li></li><a href="/gems/dry-logic/1.2">dry-logic</a><li></li><a href="/gems/dry-matcher/0.8">dry-matcher</a><li></li><a href="/gems/dry-monads/1.3">dry-monads</a><li></li><a href="/gems/dry-monitor/main">dry-monitor</a><li></li><a href="/gems/dry-rails/0.4">dry-rails</a><li></li><a href="/gems/dry-schema/1.10">dry-schema</a><li></li><a href="/gems/dry-struct/1.0">dry-struct</a><li></li><a href="/gems/dry-system/0.23">dry-system</a><li></li><a href="/gems/dry-transaction/0.13">dry-transaction</a><li></li><a href="/gems/dry-transformer/0.1">dry-transformer</a><li></li><a href="/gems/dry-types/1.2">dry-types</a><li></li><a href="/gems/dry-validation/1.8">dry-validation</a></ul><ul><li></li><a href="/gems/dry-view/0.7">dry-view</a></ul></div></li><li><a href="/status">Status</a></li><li class="main-nav__item--selected"><a href="/news">News</a></li><li><a href="/community">Community</a></li><br class="mobile-only" /><li class="main-nav__search"><form class="searchbox"><input class="form-control" id="search-input" type="text" /></form><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js" type="text/javascript"></script><script>docsearch({
  apiKey: '77902a61218a8fbaa06a6125cb6589a7',
  indexName: 'dry-rb',
  inputSelector: '#search-input',
  debug: false // Set debug to true if you want to inspect the dropdown
});</script></li><li class="main-nav__code"><a href="https://github.com/dry-rb">Github</a></li></ul></nav></div></header><div class="intro-page intro-page--content"><div class="content-wrap"><div class="intro-page__inner"><h1>Introducing dry-effects</h1><div class="news-article-meta">Published on October 03, 2019 by <a href="https://twitter.com/NikitaShilnikov">Nikita Shilnikov</a></div></div></div></div><main><div class="row"><div class="content-wrap"><article class="news-article"><p>Today we&#39;re introducing another gem and supercharging our toolset: say hello to dry-effects!</p>

<p>dry-effects is an implementation of algebraic effects in Ruby. Sound scary? Fear not! After a few examples, it&#39;ll feel very natural and compelling.</p>
<h2 id="struggling-with-side-effects" class="hd"><a name="struggling-with-side-effects" class="anchor" href="#struggling-with-side-effects">            <svg aria-hidden="true" height="16" width="16" version="1.1" viewBox="0 0 16 16">
            <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
            </svg>
</a>Struggling with side effects</h2>
<p>Writing purely functional code can be an attractive idea; it makes your code robust, testable, ... and useless! Indeed, if code doesn&#39;t perform any side effects, such as reading/writing data to the disc or network communications, the only thing it actually does is heating the CPU. On the other hand, side effects remove determinism from the code, making testing challenging. Here come algebraic effects, the underlying theory powering dry-effects.</p>
<h2 id="understanding-effects" class="hd"><a name="understanding-effects" class="anchor" href="#understanding-effects">            <svg aria-hidden="true" height="16" width="16" version="1.1" viewBox="0 0 16 16">
            <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
            </svg>
</a>Understanding effects</h2>
<p>There are two main parts to effects and effectful systems:</p>

<ol>
<li>Replace side effects with effects. These two are not the same, they are not even similar. Side effects are by definition not expected by the calling code. One cannot say if there are side effects judging by the interface. On the contrary, effects are explicitly included in interfaces; they <em>are expected</em>.</li>
<li>Running code with effects requires handling. This must be done explicitly, so that effects don&#39;t propagate straight to the outside world.</li>
</ol>

<p>These two things combined give you full control over effects in your application.</p>
<h2 id="taming-effects-with-dry-effects" class="hd"><a name="taming-effects-with-dry-effects" class="anchor" href="#taming-effects-with-dry-effects">            <svg aria-hidden="true" height="16" width="16" version="1.1" viewBox="0 0 16 16">
            <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
            </svg>
</a>Taming effects with dry-effects</h2>
<p>dry-effects uses mixins for making (or introducing) and handling (or eliminating) effects.</p>

<p>For example, this code uses the effect of getting the current time:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">CreateSubscription</span>
  <span class="kp">include</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Effects</span><span class="o">.</span><span class="no">CurrentTime</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">subscription_repo</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">start_at: </span><span class="n">current_time</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>To run it, there must be a handler:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="c1"># Rack middleware is a perfect example of a place</span>
<span class="c1"># where effects can be handled.</span>

<span class="k">class</span> <span class="nc">WithCurrentTime</span>
  <span class="kp">include</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Effects</span><span class="o">::</span><span class="no">Handler</span><span class="o">.</span><span class="no">CurrentTime</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">with_current_time</span> <span class="p">{</span> <span class="vi">@app</span><span class="o">.</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>So how is this better than <code>Time.now</code>? You get testable code for free. An RSpec example:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="kp">include</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Effects</span><span class="o">::</span><span class="no">Handler</span><span class="o">.</span><span class="no">CurrentTime</span>

<span class="n">subject</span><span class="p">(</span><span class="ss">:create_subscription</span><span class="p">)</span> <span class="p">{</span> <span class="no">CreateSubscription</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

<span class="n">example</span> <span class="s2">"creating subscription on New Year's Eve"</span> <span class="k">do</span>
  <span class="n">with_current_time</span><span class="p">(</span><span class="nb">proc</span> <span class="p">{</span> <span class="no">Time</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="p">})</span> <span class="k">do</span>
    <span class="n">create_subscription</span><span class="o">.</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Why would you use dry-effects for this instead of specialized solutions? Because it provides a universal interface to all effects, it&#39;s not limited to Ruby. For instance, getting the current time in React would look very similar:</p>
<div class="highlight"><pre class="syntax javascript"><code><span class="kd">const</span> <span class="nx">CurrentTime</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">currentTime</span> <span class="o">=</span> <span class="nx">useCurrentTime</span><span class="p">();</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="dl">"</span><span class="s2">current-time</span><span class="dl">"</span><span class="o">&gt;</span>
      <span class="p">{</span><span class="nx">currentTime</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()}:{</span><span class="nx">currentTime</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()}</span>
    <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<p>Yes, React relies on algebraic effects under the hood; maybe you already use them!</p>
<h2 id="what-else" class="hd"><a name="what-else" class="anchor" href="#what-else">            <svg aria-hidden="true" height="16" width="16" version="1.1" viewBox="0 0 16 16">
            <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
            </svg>
</a>What else?</h2>
<p>dry-effects v0.1 is already out and comes with quite a few effects supported out of the box. Some of them are “classic” and some are experimental, 17 in total.</p>

<p>Here are some:</p>

<ul>
<li>Accessing current time</li>
<li>Providing context</li>
<li>Sharing state</li>
<li>Providing environment (as opposed to accessing and manipulating <code>ENV</code>)</li>
<li>Caching</li>
<li>Locking</li>
<li>Deferred and parallel code execution</li>
</ul>

<p>One of the most compelling examples is dependency injection:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="k">class</span> <span class="nc">CreateUser</span>
  <span class="kp">include</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Effects</span><span class="o">.</span><span class="no">Resolve</span><span class="p">(</span><span class="ss">:user_repo</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">user_repo</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Here <code>CreateUser</code> is not linked to a dependency resolution implementation in any way. To provide the dependency, add a handler:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="kp">include</span> <span class="no">Dry</span><span class="o">::</span><span class="no">Effects</span><span class="o">::</span><span class="no">Handler</span><span class="o">.</span><span class="no">Resolve</span>

<span class="n">subject</span><span class="p">(</span><span class="ss">:create_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">CreateUser</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

<span class="n">let</span><span class="p">(</span><span class="ss">:user_repo</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="ss">:user_repo</span><span class="p">,</span> <span class="ss">create: </span><span class="o">...</span><span class="p">)</span> <span class="p">}</span>

<span class="n">example</span> <span class="s1">'creating a user'</span> <span class="k">do</span>
  <span class="n">provide</span><span class="p">(</span><span class="ss">user_repo: </span><span class="n">user_repo</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">create_user</span><span class="o">.</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>You can provide multiple dependencies:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="n">provide</span><span class="p">(</span><span class="ss">user_repo: </span><span class="n">user_repo</span><span class="p">,</span> <span class="ss">post_repo: </span><span class="n">post_repo</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
</code></pre></div>
<p>Handlers are also composable, you can nest them:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="n">provide</span><span class="p">(</span><span class="ss">user_repo: </span><span class="n">user_repo</span><span class="p">)</span> <span class="p">{</span> <span class="n">provide</span><span class="p">(</span><span class="ss">post_repo: </span><span class="n">post_repo</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div>
<p>This is not limited to handlers of the same type:</p>
<div class="highlight"><pre class="syntax ruby"><code><span class="n">provide</span><span class="p">(</span><span class="ss">user_repo: </span><span class="n">user_repo</span><span class="p">)</span> <span class="p">{</span> <span class="n">with_current_time</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div>
<p>Generally, effects and handlers work just the way you would expect; this is the most appealing thing about them (judging from experience!).</p>
<h2 id="why-dry-effects" class="hd"><a name="why-dry-effects" class="anchor" href="#why-dry-effects">            <svg aria-hidden="true" height="16" width="16" version="1.1" viewBox="0 0 16 16">
            <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
            </svg>
</a>Why dry-effects?</h2>
<p>These are early days for algebraic effects. We believe they have a prominent future. The concept comes from the functional world and, since dry-rb heavily leans toward functional programming, it perfectly fits our ecosystem. There is no existing production-ready library for Ruby, that&#39;s why we&#39;ve built our own.</p>

<p>This post has mostly demonstrated using effects in application code, but they can be as easily used in libraries, providing a new level of flexibility to the users. This part is yet to be explored.</p>
<h2 id="with-infinite-power-comes-infinite-responsibility" class="hd"><a name="with-infinite-power-comes-infinite-responsibility" class="anchor" href="#with-infinite-power-comes-infinite-responsibility">            <svg aria-hidden="true" height="16" width="16" version="1.1" viewBox="0 0 16 16">
            <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
            </svg>
</a>With infinite power comes infinite responsibility</h2>
<p>Algebraic effects are quite new, and as a community we have zero to little experience in using them. They may help you with writing clean, decoupled, and testable code, but they can also turn your app into unmaintainable mess, drop your database, and burn your house, so please be careful!</p>

<p>As we gather experience, together we&#39;ll figure out what&#39;s good and what&#39;s bad. So please try it, and share what you learn with others!</p>
<h2 id="dive-in" class="hd"><a name="dive-in" class="anchor" href="#dive-in">            <svg aria-hidden="true" height="16" width="16" version="1.1" viewBox="0 0 16 16">
            <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
            </svg>
</a>Dive in!</h2>
<p>The first version of dry-effects is already on <a href="https://rubygems.org/gems/dry-effects">RubyGems.org</a>, go grab it. We have <a href="https://dry-rb.org/gems/dry-effects/0.1">docs</a> for most effects and specs for all of them. As always, share your experience and ask your questions in our <a href="https://dry-rb.zulipchat.com">chat</a> and at our <a href="https://discourse.dry-rb.org/">forum</a>.</p>
</article></div></div></main><footer><div class="content-wrap"><nav class="footer__links"><ul><li><a href="/gems"><span>Gems</span></a></li><li><a href="/community"><span>Community</span></a></li><li><a href="https://github.com/dry-rb"><span>Code</span></a></li><li><a href="https://discourse.dry-rb.org"><span>Discussion</span></a></li><li><a href="https://dry-rb.zulipchat.com"><span>Chat</span></a></li><li><a href="https://twitter.com/dry_rb"><span>Twitter</span></a></li></ul></nav><div class="footer__credits"><p>Website made with love by <a href="https://www.icelab.com.au/">Icelab</a>.</p></div><div class="footer__credits"><p>Found a typo? Want to add something? <br />Send us an issue or a pull-request at <a href="https://github.com/dry-rb/dry-rb.org/">GitHub</a>.</p></div></div></footer></body></html>